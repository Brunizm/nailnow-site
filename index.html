<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="NailNow conecta clientes e manicures profissionais com agendamentos rápidos, avaliações reais e atendimento onde você estiver."
    />
    <title>NailNow | Beleza nas suas mãos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="promo-banner">Manicure sob medida: agende com profissionais verificadas onde você estiver.</div>
    <header class="site-header">
      <div class="header-inner">
        <a href="index.html" class="brand-mark" aria-label="Início da NailNow">
          NailNow
        </a>
        <div class="header-navigation">
          <nav class="primary-nav" aria-label="Principal">
            <a href="index.html" class="nav-link" aria-current="page">Home</a>
            <a href="como-funciona.html" class="nav-link">Como funciona</a>
            <a href="servicos.html" class="nav-link">Serviços</a>
            <a href="agendamentos.html" class="nav-link">Agendamentos</a>
          </nav>
          <div class="header-actions">
            <a href="cliente/index.html" class="header-cta">Sou Cliente</a>
            <a href="profissional/index.html" class="header-cta">Sou Manicure</a>
            <a
              class="social-link social-link--instagram"
              href="https://www.instagram.com/nailnowbr/"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Instagram da NailNow"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M7 3C4.24 3 2 5.24 2 8v8c0 2.76 2.24 5 5 5h10c2.76 0 5-2.24 5-5V8c0-2.76-2.24-5-5-5H7zm10 2a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8a3 3 0 0 1 3-3h10zm-5 3.5A4.5 4.5 0 1 0 16.5 13 4.5 4.5 0 0 0 12 8.5zm0 2A2.5 2.5 0 1 1 9.5 13 2.5 2.5 0 0 1 12 10.5zm4.75-4.75a1 1 0 1 0 1 1 1 1 0 0 0-1-1z"
                />
              </svg>
            </a>
          </div>
        </div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="hero-copy">
          <span class="hero-label">Para clientes</span>
          <h1>Beleza na sua agenda</h1>
          <p>
            Manicure de qualidade, onde você estiver. Agende em 3 cliques, acompanhe o deslocamento da profissional e receba atendimento premium na sua casa ou no trabalho.
          </p>
          <form class="booking-card" aria-label="Buscar manicures disponíveis" onsubmit="handleBooking(event)">
            <div class="booking-card__field">
              <label class="booking-card__label" for="booking-location">Local do atendimento</label>
              <div class="booking-card__control">
                <input
                  type="text"
                  id="booking-location"
                  class="booking-card__input"
                  name="location"
                  placeholder="Informe o endereço onde deseja ser atendida"
                  required
                />
                <svg viewBox="0 0 24 24" aria-hidden="true" class="booking-card__icon">
                  <path
                    d="M12 2.5a7 7 0 0 0-7 7c0 4.61 6.23 11.19 6.5 11.47.27.27.7.27.97 0 .27-.28 6.53-6.86 6.53-11.47a7 7 0 0 0-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"
                  />
                </svg>
              </div>
              <input type="hidden" id="booking-location-formatted" name="location_formatted" />
              <input type="hidden" id="booking-location-place-id" name="location_place_id" />
              <input type="hidden" id="booking-location-lat" name="location_lat" />
              <input type="hidden" id="booking-location-lng" name="location_lng" />
              <div
                id="booking-map"
                class="booking-card__map"
                role="presentation"
                aria-hidden="true"
                hidden
              ></div>
            </div>
            <div class="booking-card__field">
              <label class="booking-card__label" for="booking-service">Serviço desejado</label>
              <div class="booking-card__control">
                <select
                  id="booking-service"
                  class="booking-card__input"
                  name="service"
                  required
                >
                  <option value="" disabled selected hidden>Selecione um serviço</option>
                </select>
                <svg viewBox="0 0 24 24" aria-hidden="true" class="booking-card__icon">
                  <path
                    d="M5.5 3.5A2.5 2.5 0 0 0 3 6v9.5A3.5 3.5 0 0 0 6.5 19h6.76l2.84 2.84a.75.75 0 0 0 1.28-.53V19H17.5A3.5 3.5 0 0 0 21 15.5v-9a3 3 0 0 0-3-3H6.5a1 1 0 0 0-.18.02Zm.18 1.98H18a1.5 1.5 0 0 1 1.5 1.5v8.52a2 2 0 0 1-2 2h-2.02a.75.75 0 0 0-.75.75v1.3l-1.77-1.77a.75.75 0 0 0-.53-.22H6.5A2 2 0 0 1 4.5 15.5V6a1 1 0 0 1 1-1Z"
                  />
                </svg>
              </div>
            </div>
            <div class="booking-card__row">
              <div class="booking-card__field">
                <label class="booking-card__label" for="booking-date">Data</label>
                <div class="booking-card__control booking-card__control--compact">
                  <input type="date" id="booking-date" name="date" class="booking-card__input" />
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="booking-card__icon">
                    <path
                      d="M7 2a1 1 0 0 0-1 1v1H5a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3h-1V3a1 1 0 1 0-2 0v1H8V3a1 1 0 0 0-1-1Zm-2 6h14v9a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1Z"
                    />
                  </svg>
                </div>
              </div>
            <div class="booking-card__field">
              <label class="booking-card__label" for="booking-time">Horário</label>
              <div class="booking-card__control booking-card__control--compact">
                <input type="time" id="booking-time" name="time" class="booking-card__input" />
                <svg viewBox="0 0 24 24" aria-hidden="true" class="booking-card__icon">
                    <path
                      d="M12 2.5a9.5 9.5 0 1 0 9.5 9.5A9.5 9.5 0 0 0 12 2.5Zm-.75 4a.75.75 0 0 1 1.5 0v4.19l3.22 1.86a.75.75 0 0 1-.75 1.3l-3.6-2.08a.75.75 0 0 1-.37-.64Z"
                    />
                </svg>
              </div>
            </div>
          </div>
          <button type="submit" class="booking-card__submit">Agende agora</button>
          <p class="booking-card__feedback" id="booking-feedback" role="status" aria-live="polite"></p>
          <p class="booking-card__note">Suporte dedicado e avaliações reais para você escolher a manicure ideal com tranquilidade.</p>
        </form>
      </div>
      <div class="hero-media">
        <div class="hero-image-wrapper">
          <img
              src="assets/nail1.png"
              alt="Cliente sorrindo enquanto faz as unhas com uma manicure"
            />
          </div>
        </div>
      </section>

      <section class="match-results" id="match-results" hidden>
        <div class="match-results__inner">
          <header class="match-results__header">
            <span class="eyebrow" id="match-results-eyebrow">Sugestões personalizadas</span>
            <h2 id="match-results-title">Manicures ideais para você</h2>
            <p id="match-results-description">
              Informe o serviço desejado e veja profissionais verificadas prontas para atender no seu endereço.
            </p>
          </header>
          <ul class="match-results__list" id="match-results-list" role="list"></ul>
        </div>
      </section>

      <section class="cta-profissional" id="profissionais">
        <div class="cta-content">
          <span class="eyebrow">Para manicures</span>
          <h2>Seja uma manicure parceira NailNow</h2>
          <p>
            Cadastre-se gratuitamente, receba pedidos recorrentes e tenha suporte financeiro, logístico e de marketing a cada atendimento.
          </p>
        </div>
        <a href="profissional/" class="btn btn--light">Cadastrar-se</a>
      </section>

      <section class="newsletter" id="newsletter">
        <h2>Receba novidades da NailNow</h2>
        <p>
          Fique por dentro do lançamento do aplicativo, benefícios exclusivos e dicas de autocuidado.
        </p>
        <form>
          <input
            type="email"
            placeholder="Seu melhor e-mail"
            aria-label="Endereço de e-mail"
            required
          />
          <button type="submit">Quero receber</button>
        </form>
      </section>

    </main>

    <footer class="site-footer">
      <div class="footer-inner">
        <div class="footer-column footer-column--brand">
          <h2 class="footer-logo">NailNow</h2>
          <p>Beleza na sua agenda com profissionais selecionadas, atendimento onde você estiver e suporte humanizado.</p>
        </div>
        <div class="footer-column footer-links" aria-label="Links úteis">
          <h3>FAQ</h3>
          <a href="faq.html">Perguntas frequentes</a>
          <a href="como-funciona.html">Como funciona</a>
          <a href="agendamentos.html">Agendamentos</a>
        </div>
        <div class="footer-column footer-links" aria-label="Contato e suporte">
          <h3>Contato & suporte</h3>
          <a href="mailto:contato@nailnow.com">contato@nailnow.com</a>
        </div>
        <div class="footer-column footer-links" aria-label="Termos e políticas">
          <h3>Termos & políticas</h3>
          <a href="#">Termos de uso</a>
          <a href="#">Política de privacidade</a>
          <a href="#">Cookies e preferências</a>
        </div>
      </div>
      <p class="footer-copy">© NailNow 2025. Todos os direitos reservados.</p>
    </footer>

    <nav class="bottom-nav" aria-label="Navegação inferior fixa">
      <a href="index.html" class="bottom-nav__link" aria-label="Ir para o início">Home</a>
      <a href="servicos.html" class="bottom-nav__link" aria-label="Buscar serviços de manicure">Buscar</a>
      <a href="cliente/index.html" class="bottom-nav__link" aria-label="Ver agendamentos">Agendamentos</a>
      <a href="cliente/" class="bottom-nav__link" aria-label="Ver perfil ou fazer login">Perfil</a>
    </nav>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBHVZ9M6btJemXCIG-g5dG0xWq_jy50H7o",
        authDomain: "nailnow-site.firebaseapp.com",
        projectId: "nailnow-site",
        storageBucket: "nailnow-site.appspot.com",
        messagingSenderId: "726392294571",
        appId: "1:726392294571:web:a363a40231f7ac162e7bee",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const accentPalette = ["rose", "sunset", "violet", "ocean", "blush", "lavender"];

      const allowedServices = [
        "Manicure clássica",
        "Pedicure clássica",
        "Alongamento em gel",
        "Esmaltação em gel (manicure)",
        "Esmaltação em gel (pedicure)",
      ];

      const allowedServicesMap = new Map(
        allowedServices.map((service) => [service.toLowerCase(), service])
      );

      const defaultMapCenter = { lat: -14.235004, lng: -51.92528 };

      let bookingMapElement = null;
      let bookingMapInstance = null;
      let bookingMapInitialized = false;
      let clientMarker = null;
      let professionalMarkers = [];
      let lastClientCoordinates = null;
      let lastClientLabel = "";

      const fallbackManicureCatalog = [
        {
          id: "ana-luiza",
          name: "Ana Luiza",
          initials: "AL",
          rating: 4.9,
          reviews: 128,
          focus: "Especialista em manicure clássica com acabamento em gel impecável.",
          services: [
            "Manicure clássica",
            "Esmaltação em gel (manicure)",
            "Esmaltação em gel (pedicure)",
          ],
          areas: ["São Paulo", "SP", "Zona Sul"],
          badge: "Zona Sul · São Paulo",
          accent: "rose",
          location: { lat: -23.602, lng: -46.663 },
          city: "São Paulo",
          photoUrl: "",
        },
        {
          id: "mariana-costa",
          name: "Mariana Costa",
          initials: "MC",
          rating: 4.8,
          reviews: 142,
          focus: "Referência em alongamento em gel com manutenção rápida para eventos.",
          services: ["Alongamento em gel", "Esmaltação em gel (manicure)", "Manicure clássica"],
          areas: ["Belo Horizonte", "BH", "Centro"],
          badge: "Centro · Belo Horizonte",
          accent: "sunset",
          location: { lat: -19.919, lng: -43.938 },
          city: "Belo Horizonte",
          photoUrl: "",
        },
        {
          id: "juliana-prado",
          name: "Juliana Prado",
          initials: "JP",
          rating: 4.95,
          reviews: 96,
          focus: "Consultoria de cor com manicure clássica e cobertura em gel para noivas.",
          services: ["Manicure clássica", "Alongamento em gel", "Esmaltação em gel (manicure)"],
          areas: ["Belo Horizonte", "Savassi", "BH"],
          badge: "Savassi · Belo Horizonte",
          accent: "violet",
          location: { lat: -19.934, lng: -43.935 },
          city: "Belo Horizonte",
          photoUrl: "",
        },
        {
          id: "camila-duarte",
          name: "Camila Duarte",
          initials: "CD",
          rating: 4.7,
          reviews: 88,
          focus: "Pedicure clássica relaxante com opções de esmaltação em gel.",
          services: ["Pedicure clássica", "Esmaltação em gel (pedicure)", "Manicure clássica"],
          areas: ["São Paulo", "Zona Oeste", "Perdizes"],
          badge: "Zona Oeste · São Paulo",
          accent: "ocean",
          location: { lat: -23.538, lng: -46.679 },
          city: "São Paulo",
          photoUrl: "",
        },
        {
          id: "rafaela-nunes",
          name: "Rafaela Nunes",
          initials: "RN",
          rating: 4.85,
          reviews: 110,
          focus: "Alongamento em gel com esmaltação de longa duração para eventos.",
          services: ["Alongamento em gel", "Esmaltação em gel (manicure)", "Pedicure clássica"],
          areas: ["Rio de Janeiro", "RJ", "Barra da Tijuca"],
          badge: "Barra da Tijuca · Rio de Janeiro",
          accent: "blush",
          location: { lat: -23.000, lng: -43.365 },
          city: "Rio de Janeiro",
          photoUrl: "",
        },
        {
          id: "bianca-alves",
          name: "Bianca Alves",
          initials: "BA",
          rating: 4.92,
          reviews: 101,
          focus: "Experiência premium com alongamento em gel e pedicure clássica.",
          services: ["Alongamento em gel", "Pedicure clássica", "Manicure clássica"],
          areas: ["Curitiba", "PR", "Batel"],
          badge: "Batel · Curitiba",
          accent: "lavender",
          location: { lat: -25.441, lng: -49.287 },
          city: "Curitiba",
          photoUrl: "",
        },
      ];

      let manicureCatalog = fallbackManicureCatalog.slice();
      let professionalsPromise = null;

      const accentClassMap = {
        rose: "match-results__avatar--rose",
        sunset: "match-results__avatar--sunset",
        violet: "match-results__avatar--violet",
        ocean: "match-results__avatar--ocean",
        blush: "match-results__avatar--blush",
        lavender: "match-results__avatar--lavender",
      };

      function toNumber(value) {
        if (typeof value === "number") {
          return Number.isFinite(value) ? value : null;
        }
        if (typeof value === "string") {
          const parsed = parseFloat(value.replace(',', '.'));
          return Number.isFinite(parsed) ? parsed : null;
        }
        return null;
      }

      function ensureBookingMap() {
        if (!window.google?.maps) return null;

        if (!bookingMapElement) {
          bookingMapElement = document.getElementById("booking-map");
        }

        if (!bookingMapElement) return null;

        if (!bookingMapInstance) {
          bookingMapInstance = new google.maps.Map(bookingMapElement, {
            center: defaultMapCenter,
            zoom: 4,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            clickableIcons: false,
            zoomControl: true,
          });
        }

        return bookingMapInstance;
      }

      function showBookingMap() {
        if (!bookingMapElement) return;
        bookingMapElement.hidden = false;
        bookingMapElement.setAttribute("aria-hidden", "false");
      }

      function hideBookingMap() {
        if (!bookingMapElement) {
          bookingMapElement = document.getElementById("booking-map");
        }

        if (bookingMapElement) {
          bookingMapElement.hidden = true;
          bookingMapElement.setAttribute("aria-hidden", "true");
        }

        if (clientMarker) {
          clientMarker.setMap(null);
          clientMarker = null;
        }

        professionalMarkers.forEach((marker) => marker.setMap(null));
        professionalMarkers = [];
      }

      function clearProfessionalMarkers() {
        professionalMarkers.forEach((marker) => marker.setMap(null));
        professionalMarkers = [];
      }

      function updateClientMarkerOnMap(coordinates, label) {
        const map = ensureBookingMap();
        if (!map) return;

        if (!coordinates || !Number.isFinite(coordinates.lat) || !Number.isFinite(coordinates.lng)) {
          hideBookingMap();
          return;
        }

        showBookingMap();

        const position = { lat: coordinates.lat, lng: coordinates.lng };

        if (!clientMarker) {
          clientMarker = new google.maps.Marker({
            map,
            position,
            title: label || "Local do atendimento",
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 10,
              fillColor: "#F45CA2",
              fillOpacity: 1,
              strokeColor: "#ffffff",
              strokeWeight: 3,
            },
          });
        } else {
          clientMarker.setMap(map);
          clientMarker.setPosition(position);
          clientMarker.setTitle(label || "Local do atendimento");
        }

        map.panTo(position);
        if (map.getZoom() < 12) {
          map.setZoom(12);
        }
      }

      function updateMapWithMatches(items, clientCoordinates, locationLabel) {
        lastClientCoordinates = clientCoordinates ?? null;
        lastClientLabel = locationLabel ?? "";

        if (!clientCoordinates || !Number.isFinite(clientCoordinates.lat) || !Number.isFinite(clientCoordinates.lng)) {
          hideBookingMap();
          return;
        }

        const map = ensureBookingMap();
        if (!map) return;

        updateClientMarkerOnMap(clientCoordinates, lastClientLabel);

        clearProfessionalMarkers();

        const matchesWithLocation = [];
        (items || []).forEach((item) => {
          const lat = toNumber(item?.pro?.location?.lat);
          const lng = toNumber(item?.pro?.location?.lng);

          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            matchesWithLocation.push({ item, position: { lat, lng } });
          }
        });

        if (!matchesWithLocation.length) {
          map.panTo({ lat: clientCoordinates.lat, lng: clientCoordinates.lng });
          if (map.getZoom() < 12) {
            map.setZoom(12);
          }
          return;
        }

        const bounds = new google.maps.LatLngBounds();
        bounds.extend(clientCoordinates);

        matchesWithLocation.slice(0, 6).forEach(({ item, position }, index) => {
          const marker = new google.maps.Marker({
            map,
            position,
            title: `${item.pro.name} · ${item.pro.badge || "Profissional NailNow"}`,
            label: {
              text: String(index + 1),
              color: "#ffffff",
              fontSize: "12px",
              fontWeight: "700",
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 10,
              fillColor: "#FF6EA9",
              fillOpacity: 1,
              strokeColor: "#ffffff",
              strokeWeight: 3,
            },
          });
          professionalMarkers.push(marker);
          bounds.extend(position);
        });

        map.fitBounds(bounds, 64);
      }

      function initBookingMap() {
        if (bookingMapInitialized) return;
        const map = ensureBookingMap();
        if (map) {
          bookingMapInitialized = true;
        }
      }

      function getInitials(name) {
        return name
          .split(/\s+/)
          .filter(Boolean)
          .slice(0, 2)
          .map((part) => part[0]?.toUpperCase() || "")
          .join("");
      }

      function normalizeServiceName(value) {
        if (!value) return null;
        const normalized = value.toString().trim().toLowerCase();
        return allowedServicesMap.get(normalized) ?? null;
      }

      function normalizeProfessional(doc, index) {
        const data = doc.data();
        if (!data) return null;

        const rawName = (data.nome ?? "").toString().trim();
        const name = rawName || "Profissional NailNow";
        let services = Array.isArray(data.servicos) && data.servicos.length
          ? data.servicos
          : [allowedServices[0]];

        services = services
          .map((service) => normalizeServiceName(service))
          .filter(Boolean);

        if (!services.length) {
          services = [allowedServices[0]];
        } else {
          services = Array.from(new Set(services));
        }

        const lat = toNumber(data.lat);
        const lng = toNumber(data.lng);
        const location = lat !== null && lng !== null ? { lat, lng } : null;

        const areaCandidates = [data.cidade, data.estado, data.endereco, data.endereco_formatado]
          .filter(Boolean)
          .flatMap((value) => value.split(/,|·/).map((part) => part.trim()))
          .filter(Boolean);

        const city = (data.cidade ?? "").toString().trim();
        const state = (data.estado ?? "").toString().trim();
        const badgeParts = [city, state].filter(Boolean);
        const badge = badgeParts.length
          ? `${badgeParts.join(' · ')}`
          : (data.endereco_formatado || data.endereco || "Atendimento móvel");

        const rating = toNumber(data.rating);
        const reviewsNumber = toNumber(data.reviews);

        return {
          id: doc.id,
          name,
          initials: getInitials(name) || "NN",
          rating: rating ?? undefined,
          reviews: reviewsNumber !== null ? Math.max(0, Math.round(reviewsNumber)) : undefined,
          focus: (data.bio ?? "").toString().trim() || "Atendimento NailNow personalizado no seu endereço.",
          services,
          areas: areaCandidates.length ? areaCandidates : services,
          badge,
          accent: accentPalette[index % accentPalette.length],
          photoUrl: data.fotoUrl || "",
          location,
          city,
        };
      }

      async function loadProfessionalsFromFirestore() {
        try {
          const snapshot = await getDocs(collection(db, "profissionais"));
          const remoteCatalog = snapshot.docs
            .map((doc, index) => normalizeProfessional(doc, index))
            .filter(Boolean);

          if (remoteCatalog.length) {
            manicureCatalog = remoteCatalog;
            populateServiceSelect();
          }
        } catch (error) {
          console.error("Erro ao carregar profissionais cadastradas", error);
        }
      }

      function getCatalogServices() {
        const catalogServices = new Set();
        manicureCatalog.forEach((pro) => {
          (pro.services || []).forEach((service) => {
            const normalized = normalizeServiceName(service);
            if (normalized) {
              catalogServices.add(normalized);
            }
          });
        });

        if (!catalogServices.size) {
          allowedServices.forEach((service) => catalogServices.add(service));
        }

        return Array.from(catalogServices).sort((a, b) => a.localeCompare(b, "pt-BR"));
      }

      function populateServiceSelect() {
        const select = document.getElementById("booking-service");
        if (!select) return;

        const previousSelection = select.value;

        Array.from(select.querySelectorAll("option[data-generated='true']")).forEach((option) =>
          option.remove()
        );

        const services = getCatalogServices();

        services.forEach((service) => {
          const option = document.createElement("option");
          option.value = service;
          option.textContent = service;
          option.dataset.generated = "true";
          select.appendChild(option);
        });

        if (previousSelection && services.includes(previousSelection)) {
          select.value = previousSelection;
        } else {
          select.value = "";
        }
      }

      function formatDistance(kilometers) {
        if (!Number.isFinite(kilometers)) return null;
        if (kilometers < 1) {
          const meters = Math.max(50, Math.round(kilometers * 1000));
          return `${meters} m de você`;
        }
        const formatter = new Intl.NumberFormat("pt-BR", {
          minimumFractionDigits: kilometers < 10 ? 1 : 0,
          maximumFractionDigits: kilometers < 10 ? 1 : 0,
        });
        return `${formatter.format(kilometers)} km de você`;
      }

      function calculateDistance(origin, destination) {
        if (!origin || !destination) return null;
        const originLat = toNumber(origin.lat);
        const originLng = toNumber(origin.lng);
        const destinationLat = toNumber(destination.lat);
        const destinationLng = toNumber(destination.lng);

        if ([originLat, originLng, destinationLat, destinationLng].some((value) => !Number.isFinite(value))) {
          return null;
        }

        const toRadians = (deg) => (deg * Math.PI) / 180;
        const earthRadius = 6371;
        const dLat = toRadians(destinationLat - originLat);
        const dLng = toRadians(destinationLng - originLng);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRadians(originLat)) *
            Math.cos(toRadians(destinationLat)) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return earthRadius * c;
      }

      function createMatchCard(item, serviceQuery) {
        const { pro, distanceKm } = item;
        const element = document.createElement("li");
        element.className = "match-results__card";

        const avatar = document.createElement("div");
        avatar.className = "match-results__avatar";
        const accentClass = accentClassMap[pro.accent];
        if (accentClass) {
          avatar.classList.add(accentClass);
        }

        if (pro.photoUrl) {
          avatar.classList.add("match-results__avatar--with-photo");
          const img = document.createElement("img");
          img.src = pro.photoUrl;
          img.alt = `Foto da profissional ${pro.name}`;
          avatar.textContent = "";
          avatar.appendChild(img);
        } else {
          avatar.textContent = pro.initials || getInitials(pro.name);
          avatar.setAttribute("aria-hidden", "true");
        }

        const content = document.createElement("div");
        content.className = "match-results__content";

        const header = document.createElement("div");
        header.className = "match-results__card-header";

        const name = document.createElement("h3");
        name.textContent = pro.name;
        header.appendChild(name);

        if (typeof pro.rating === "number") {
          const rating = document.createElement("span");
          rating.className = "match-results__rating";
          const ratingDisplay = new Intl.NumberFormat("pt-BR", {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1,
          }).format(pro.rating);
          rating.textContent = `★ ${ratingDisplay}`;
          const reviewsLabel =
            pro.reviews !== undefined ? `${pro.reviews} avaliações` : "Avaliações NailNow";
          rating.title = `${ratingDisplay} · ${reviewsLabel}`;
          rating.setAttribute("aria-label", `Avaliação média ${ratingDisplay} de 5`);
          header.appendChild(rating);
        }

        const blurb = document.createElement("p");
        blurb.className = "match-results__blurb";
        blurb.textContent = pro.focus;

        const meta = document.createElement("div");
        meta.className = "match-results__meta";

        if (pro.badge) {
          const locationBadge = document.createElement("span");
          locationBadge.className = "match-results__badge";
          locationBadge.textContent = pro.badge;
          meta.appendChild(locationBadge);
        }

        const servicesText = (pro.services || []).slice(0, 3).join(" · ");
        if (servicesText) {
          const services = document.createElement("span");
          services.className = "match-results__services";
          services.textContent = servicesText;
          meta.appendChild(services);
        }

        if (Number.isFinite(distanceKm)) {
          const distance = document.createElement("span");
          distance.className = "match-results__distance";
          const label = formatDistance(distanceKm);
          if (label) {
            distance.textContent = label;
            meta.appendChild(distance);
          }
        }

        const cta = document.createElement("a");
        cta.className = "match-results__cta";
        const params = new URLSearchParams({
          profissional: pro.id,
          servico: serviceQuery || (pro.services?.[0] ?? "Manicure"),
        });
        cta.href = `cliente/cadastro.html?${params.toString()}`;
        cta.textContent = "Reservar atendimento";

        content.appendChild(header);
        content.appendChild(blurb);
        content.appendChild(meta);
        content.appendChild(cta);

        element.appendChild(avatar);
        element.appendChild(content);

        return element;
      }

      function scoreMatches(serviceQuery, coordinates) {
        const canonicalService = normalizeServiceName(serviceQuery);
        const normalizedService = canonicalService
          ? canonicalService.toLowerCase()
          : serviceQuery.toLowerCase();
        const hasCoordinates = Boolean(coordinates);

        return manicureCatalog
          .map((pro, index) => {
            const services = Array.isArray(pro.services) ? pro.services : [];
            const serviceMatch = services.some(
              (service) => service.toLowerCase() === normalizedService
            );

            if (!serviceMatch) {
              return null;
            }

            const distanceKm = hasCoordinates && pro.location
              ? calculateDistance(coordinates, pro.location)
              : null;

            const ratingScore = typeof pro.rating === "number" ? pro.rating : 4.5 - index * 0.05;
            const distanceScore = Number.isFinite(distanceKm)
              ? Math.max(0, 5 - Math.min(distanceKm, 80) / 12)
              : 0;

            return {
              pro,
              distanceKm,
              score: 6 + ratingScore + distanceScore,
            };
          })
          .filter(Boolean)
          .sort((a, b) => {
            const aHasDistance = Number.isFinite(a.distanceKm);
            const bHasDistance = Number.isFinite(b.distanceKm);

            if (aHasDistance && bHasDistance && Math.abs(a.distanceKm - b.distanceKm) > 0.25) {
              return a.distanceKm - b.distanceKm;
            }
            if (aHasDistance && !bHasDistance) return -1;
            if (!aHasDistance && bHasDistance) return 1;
            return b.score - a.score;
          });
      }

      function updateBookingFeedback(message, type = "info") {
        const feedback = document.getElementById("booking-feedback");
        if (!feedback) return;
        feedback.textContent = message;
        feedback.className = "booking-card__feedback";
        if (type === "error") {
          feedback.classList.add("booking-card__feedback--error");
        } else if (type === "success") {
          feedback.classList.add("booking-card__feedback--success");
        }
      }

      function renderMatches(matches, serviceQuery, locationLabel, coordinates) {
        const section = document.getElementById("match-results");
        const list = document.getElementById("match-results-list");
        const title = document.getElementById("match-results-title");
        const description = document.getElementById("match-results-description");
        const eyebrow = document.getElementById("match-results-eyebrow");

        if (!section || !list || !title || !description || !eyebrow) return;

        list.innerHTML = "";

        let itemsToShow = matches;

        if (!itemsToShow.length) {
          const fallbackItems = manicureCatalog
            .map((pro, index) => {
              const distanceKm = coordinates && pro.location
                ? calculateDistance(coordinates, pro.location)
                : null;
              const ratingScore = typeof pro.rating === "number" ? pro.rating : 4.4 - index * 0.04;
              return { pro, distanceKm, score: ratingScore };
            })
            .sort((a, b) => {
              const aHasDistance = Number.isFinite(a.distanceKm);
              const bHasDistance = Number.isFinite(b.distanceKm);

              if (aHasDistance && bHasDistance && Math.abs(a.distanceKm - b.distanceKm) > 0.25) {
                return a.distanceKm - b.distanceKm;
              }
              if (aHasDistance && !bHasDistance) return -1;
              if (!aHasDistance && bHasDistance) return 1;
              return (b.score ?? 0) - (a.score ?? 0);
            });

          itemsToShow = fallbackItems;
          eyebrow.textContent = "Profissionais em destaque";
          title.textContent = `Ainda não temos especialistas em "${serviceQuery}" na sua região`;
          description.textContent = locationLabel
            ? "Veja manicures bem avaliadas que atendem próximas às principais regiões."
            : "Veja manicures bem avaliadas e disponíveis para novos agendamentos.";

          const fallbackMessage = locationLabel
            ? `Ainda não encontramos ${serviceQuery.toLowerCase()} próximo de ${locationLabel}. Confira nossas profissionais em destaque.`
            : "Confira manicures em destaque prontas para novos agendamentos.";
          updateBookingFeedback(fallbackMessage);
        } else {
          eyebrow.textContent = "Combinações perfeitas";
          const locationSuffix = locationLabel ? ` em ${locationLabel}` : "";
          title.textContent = `Manicures para "${serviceQuery}"${locationSuffix}`;
          description.textContent = locationLabel
            ? `Selecionamos profissionais que oferecem ${serviceQuery.toLowerCase()} e atendem em ${locationLabel}.`
            : `Selecionamos profissionais que oferecem ${serviceQuery.toLowerCase()} com ótima avaliação.`;

          const resultWord = matches.length === 1 ? "profissional" : "profissionais";
          updateBookingFeedback(
            `${matches.length} ${resultWord} encontrada(s) para ${serviceQuery.toLowerCase()}${locationSuffix}.`,
            "success"
          );
        }

        itemsToShow.forEach((item) => {
          const element = createMatchCard(item, serviceQuery);
          list.appendChild(element);
        });

        updateMapWithMatches(itemsToShow, coordinates, locationLabel);

        section.hidden = false;
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function initBookingAutocomplete() {
        const input = document.getElementById("booking-location");
        if (!input || input.dataset.autocompleteInitialized === "true") return;

        const formattedField = document.getElementById("booking-location-formatted");
        const placeIdField = document.getElementById("booking-location-place-id");
        const latField = document.getElementById("booking-location-lat");
        const lngField = document.getElementById("booking-location-lng");

        if (!window.google || !google.maps?.places) {
          return;
        }

        const autocomplete = new google.maps.places.Autocomplete(input, {
          types: ["geocode"],
          componentRestrictions: { country: "br" },
          fields: ["formatted_address", "place_id", "geometry"],
        });

        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();
          const geometry = place.geometry?.location;
          formattedField.value = place.formatted_address || input.value.trim();
          placeIdField.value = place.place_id || "";
          const latitude = geometry ? geometry.lat() : "";
          const longitude = geometry ? geometry.lng() : "";
          latField.value = latitude;
          lngField.value = longitude;

          const coordinates =
            typeof latitude === "number" && typeof longitude === "number"
              ? { lat: latitude, lng: longitude }
              : null;

          if (coordinates) {
            updateMapWithMatches([], coordinates, formattedField.value || input.value.trim());
          } else {
            hideBookingMap();
          }
        });

        input.addEventListener("input", () => {
          if (!input.value.trim()) {
            formattedField.value = "";
            placeIdField.value = "";
            latField.value = "";
            lngField.value = "";
            lastClientCoordinates = null;
            lastClientLabel = "";
            hideBookingMap();
          }
        });

        input.dataset.autocompleteInitialized = "true";
      }

      async function handleBooking(event) {
        event.preventDefault();
        const form = event.target;
        const serviceField = form.querySelector("[name='service']");
        const locationField = form.querySelector("[name='location']");
        const formattedField = form.querySelector("[name='location_formatted']");
        const latField = form.querySelector("[name='location_lat']");
        const lngField = form.querySelector("[name='location_lng']");

        if (!serviceField || !locationField) return;

        const serviceQuery = serviceField.value.trim();
        const locationQuery = locationField.value.trim();
        const latValue = latField ? toNumber(latField.value) : null;
        const lngValue = lngField ? toNumber(lngField.value) : null;

        if (!serviceQuery) {
          updateBookingFeedback("Informe o serviço desejado para continuarmos.", "error");
          serviceField.focus();
          return;
        }

        if (!locationQuery) {
          updateBookingFeedback("Informe o local do atendimento.", "error");
          locationField.focus();
          return;
        }

        if (latValue === null || lngValue === null) {
          updateBookingFeedback("Escolha um endereço sugerido para calcularmos as profissionais mais próximas.", "error");
          locationField.focus();
          return;
        }

        updateBookingFeedback("Buscando manicures próximas...");

        try {
          if (!professionalsPromise) {
            professionalsPromise = loadProfessionalsFromFirestore();
          }
          await professionalsPromise;

          const coordinates = { lat: latValue, lng: lngValue };
          const locationLabel = formattedField?.value || locationQuery;
          const matches = scoreMatches(serviceQuery, coordinates);
          renderMatches(matches, serviceQuery, locationLabel, coordinates);
        } catch (error) {
          console.error("Erro ao buscar manicures", error);
          updateBookingFeedback(
            "Não foi possível buscar as profissionais agora. Tente novamente em instantes.",
            "error"
          );
        }
      }

      function initMapsFeatures() {
        initBookingAutocomplete();
        initBookingMap();
      }

      window.handleBooking = handleBooking;
      window.initMapsFeatures = initMapsFeatures;
      window.initBookingAutocomplete = initBookingAutocomplete;
      window.initBookingMap = initBookingMap;

      document.addEventListener("DOMContentLoaded", () => {
        populateServiceSelect();
        professionalsPromise = loadProfessionalsFromFirestore();
      });

      window.addEventListener("load", () => {
        if (window.google?.maps) {
          initMapsFeatures();
        }
      });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCeFS75JZeUXATAztu5ntNpgCT-wfNlai0&libraries=places&language=pt-BR&region=BR&callback=initMapsFeatures" async defer></script>
  </body>
</html>
