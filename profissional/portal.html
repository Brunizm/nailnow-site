<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NailNow | Portal da Manicure</title>
    <meta
      name="description"
      content="Portal da Manicure NailNow — autonomia, visibilidade e pagamentos seguros. Cadastre-se e conquiste clientes."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <div class="promo-banner">Profissionais sob medida: agende especialistas verificadas onde você estiver.</div>
    <header class="site-header">
      <div class="header-inner">
        <a href="../index.html" class="brand-mark" aria-label="Início da NailNow">
          NailNow
        </a>
        <div class="header-navigation">
          <nav class="primary-nav" aria-label="Principal">
            <a href="../index.html" class="nav-link">Home</a>
            <a href="../como-funciona.html" class="nav-link">Como funciona</a>
            <a href="../servicos.html" class="nav-link">Serviços</a>
            <a href="../agendamentos.html" class="nav-link">Agendamentos</a>
          </nav>
          <div class="header-actions">
            <a href="../cliente/index.html" class="header-cta">Sou Cliente</a>
            <a href="../profissional/index.html" class="header-cta">Sou Profissional</a>
            <a href="./portal.html" class="header-cta" aria-current="page">Entrar no Portal</a>
            <a
              class="social-link social-link--instagram"
              href="https://www.instagram.com/nailnowbr/"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Instagram da NailNow"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M7 3C4.24 3 2 5.24 2 8v8c0 2.76 2.24 5 5 5h10c2.76 0 5-2.24 5-5V8c0-2.76-2.24-5-5-5H7zm10 2a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8a3 3 0 0 1 3-3h10zm-5 3.5A4.5 4.5 0 1 0 16.5 13 4.5 4.5 0 0 0 12 8.5zm0 2A2.5 2.5 0 1 1 9.5 13 2.5 2.5 0 0 1 12 10.5zm4.75-4.75a1 1 0 1 0 1 1 1 1 0 0 0-1-1z"
                />
              </svg>
            </a>
          </div>
        </div>
      </div>
    </header>

    <main class="page-content">
      <div id="login-view" class="auth-layout" aria-labelledby="auth-heading">
        <section class="auth-hero">
          <p class="auth-kicker">Painel para manicures NailNow</p>
          <h1 id="auth-heading">Faça login para cuidar da sua agenda</h1>
          <p class="auth-intro">
            Acesse seu espaço exclusivo para confirmar atendimentos, organizar horários e acompanhar pagamentos com segurança.
          </p>
          <ul class="auth-benefits">
            <li>Sincronize sua agenda em tempo real com os pedidos das clientes.</li>
            <li>Confirme reservas com um toque e receba notificações instantâneas.</li>
            <li>Controle seus ganhos e acompanhe o histórico de atendimentos.</li>
          </ul>
        </section>

        <section class="auth-card" aria-labelledby="login-heading">
          <div class="auth-card__inner">
            <h2 id="login-heading">Entrar com e-mail e senha</h2>
            <p class="auth-card__hint">Use o e-mail cadastrado na NailNow para acessar o painel de manicures.</p>
            <form id="login-form" class="auth-form" novalidate>
              <div class="auth-form__group">
                <label for="email">E-mail</label>
                <input type="email" id="email" name="email" autocomplete="email" required placeholder="seunome@nailnow.com" />
              </div>
              <div class="auth-form__group">
                <label for="password">Senha</label>
                <input type="password" id="password" name="password" autocomplete="current-password" required placeholder="•••••••" />
              </div>
              <button type="submit" class="auth-form__submit">Entrar</button>
            </form>
            <div id="login-status" class="auth-status" role="alert" aria-live="polite" hidden></div>
            <div class="auth-actions">
              <button type="button" id="reset-password" class="auth-link-button">Esqueci minha senha</button>
              <a href="./cadastro.html" class="auth-secondary-link">Ainda não é parceira? Cadastre-se</a>
            </div>
          </div>
        </section>
      </div>

      <div id="dashboard" class="dashboard" hidden aria-labelledby="dashboard-heading">
        <section class="dashboard-hero">
          <div class="dashboard-hero__header">
            <div>
              <p class="dashboard-kicker">Painel NailNow</p>
              <h1 id="dashboard-heading">Olá, <span data-profile-name>manicure</span>!</h1>
              <p class="dashboard-intro">Gerencie sua agenda, acompanhe solicitações e mantenha o relacionamento com suas clientes em um só lugar.</p>
            </div>
            <button type="button" id="sign-out" class="dashboard-signout">Sair</button>
          </div>
          <div class="dashboard-summary">
            <article class="profile-card" aria-labelledby="profile-heading">
              <h2 id="profile-heading">Meu perfil</h2>
              <dl class="profile-details">
                <div class="profile-details__item">
                  <dt>Nome</dt>
                  <dd id="profile-display">—</dd>
                </div>
                <div class="profile-details__item">
                  <dt>E-mail</dt>
                  <dd id="profile-email">—</dd>
                </div>
                <div class="profile-details__item">
                  <dt>Especialidades</dt>
                  <dd id="profile-specialties">Alongamento em fibra · Spa das mãos</dd>
                </div>
                <div class="profile-details__item">
                  <dt>Área de atendimento</dt>
                  <dd id="profile-area">São Paulo e região metropolitana</dd>
                </div>
              </dl>
            </article>
            <div class="dashboard-metrics" aria-label="Resumo da agenda">
              <div class="metric-card">
                <span class="metric-label">Solicitações</span>
                <span class="metric-value" id="metric-pending">0</span>
                <span class="metric-footnote">aguardando resposta</span>
              </div>
              <div class="metric-card">
                <span class="metric-label">Confirmados</span>
                <span class="metric-value" id="metric-confirmed">0</span>
                <span class="metric-footnote">para os próximos dias</span>
              </div>
              <div class="metric-card">
                <span class="metric-label">Últimos 30 dias</span>
                <span class="metric-value" id="metric-past">0</span>
                <span class="metric-footnote">atendimentos concluídos</span>
              </div>
            </div>
          </div>
        </section>

        <section class="schedule-section" aria-labelledby="pending-heading">
          <div class="schedule-section__head">
            <h2 id="pending-heading">Solicitações de agendamento</h2>
            <span class="schedule-count" id="badge-pending">0</span>
          </div>
          <div id="pending-list" class="schedule-list" role="list"></div>
        </section>

        <section class="schedule-section" aria-labelledby="confirmed-heading">
          <div class="schedule-section__head">
            <h2 id="confirmed-heading">Agendamentos confirmados</h2>
            <span class="schedule-count" id="badge-confirmed">0</span>
          </div>
          <div id="confirmed-list" class="schedule-list" role="list"></div>
        </section>

        <section class="schedule-section" aria-labelledby="past-heading">
          <div class="schedule-section__head">
            <h2 id="past-heading">Atendimentos realizados</h2>
            <span class="schedule-count" id="badge-past">0</span>
          </div>
          <div id="past-list" class="schedule-list" role="list"></div>
        </section>
      </div>
    </main>

    <footer class="site-footer">
      <div class="footer-inner">
        <div class="footer-column footer-column--brand">
          <h2 class="footer-logo">NailNow</h2>
          <p>Beleza na sua agenda com profissionais selecionadas, atendimento onde você estiver e suporte humanizado.</p>
        </div>
        <div class="footer-column footer-links" aria-label="Links úteis">
          <h3>FAQ</h3>
          <a href="../faq.html">Perguntas frequentes</a>
          <a href="../como-funciona.html">Como funciona</a>
          <a href="../agendamentos.html">Agendamentos</a>
        </div>
        <div class="footer-column footer-links" aria-label="Contato e suporte">
          <h3>Contato & suporte</h3>
          <a href="mailto:contato@nailnow.com">contato@nailnow.com</a>
        </div>
        <div class="footer-column footer-links" aria-label="Termos e políticas">
          <h3>Termos & políticas</h3>
          <a href="#">Termos de uso</a>
          <a href="#">Política de privacidade</a>
          <a href="#">Cookies e preferências</a>
        </div>
      </div>
      <p class="footer-copy">© NailNow 2025. Todos os direitos reservados.</p>
    </footer>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        Timestamp,
        collection,
        doc,
        getDoc,
        getDocs,
        getFirestore,
        limit,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDvMxPKyw7M70fvj-YLwzudfIaquohkDIA",
        authDomain: "nailnow-site.firebaseapp.com",
        projectId: "nailnow-site",
        storageBucket: "nailnow-site.appspot.com",
        messagingSenderId: "145591976960",
        appId: "1:145591976960:web:957f13cd9d61acdfda4dde",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const loginForm = document.getElementById("login-form");
      const statusEl = document.getElementById("login-status");
      const submitButton = loginForm.querySelector("button[type='submit']");
      const resetButton = document.getElementById("reset-password");
      const loginView = document.getElementById("login-view");
      const dashboard = document.getElementById("dashboard");
      const signOutButton = document.getElementById("sign-out");
      const profileNameElements = document.querySelectorAll("[data-profile-name]");
      const profileDisplay = document.getElementById("profile-display");
      const profileEmail = document.getElementById("profile-email");
      const profileSpecialties = document.getElementById("profile-specialties");
      const profileArea = document.getElementById("profile-area");
      const metricPending = document.getElementById("metric-pending");
      const metricConfirmed = document.getElementById("metric-confirmed");
      const metricPast = document.getElementById("metric-past");
      const badgePending = document.getElementById("badge-pending");
      const badgeConfirmed = document.getElementById("badge-confirmed");
      const badgePast = document.getElementById("badge-past");
      const pendingList = document.getElementById("pending-list");
      const confirmedList = document.getElementById("confirmed-list");
      const pastList = document.getElementById("past-list");

      const sessionKey = "nailnowPortalManicure";

      const defaultAppointmentData = {
        pending: [
          {
            id: "SOL-1842",
            client: "Bianca Lopes",
            service: "Alongamento em fibra de vidro",
            date: "2025-05-08",
            time: "14:00",
            location: "Pinheiros, São Paulo",
            price: "R$ 180,00",
            note: "Prefere acabamento natural e formato amendoado.",
          },
          {
            id: "SOL-1853",
            client: "Thais Camargo",
            service: "Spa das mãos + esmaltação gel",
            date: "2025-05-09",
            time: "09:30",
            location: "Brooklin, São Paulo",
            price: "R$ 140,00",
            note: "Levar paleta de tons nudes.",
          },
        ],
        confirmed: [
          {
            id: "AGEN-1027",
            client: "Larissa Monteiro",
            service: "Blindagem + esmaltação",
            date: "2025-05-06",
            time: "18:30",
            location: "Vila Mariana, São Paulo",
            price: "R$ 165,00",
            note: "Cliente indicou preferência por glitter rosé.",
          },
          {
            id: "AGEN-1028",
            client: "Amanda Reis",
            service: "Pedicure + spa relaxante",
            date: "2025-05-07",
            time: "10:00",
            location: "Moema, São Paulo",
            price: "R$ 120,00",
            note: "Chegar 10 min antes para montagem do espaço.",
          },
        ],
        past: [
          {
            id: "HIST-980",
            client: "Nathalia Cruz",
            service: "Esmaltação em gel",
            date: "2025-04-29",
            time: "16:30",
            location: "Itaim Bibi, São Paulo",
            price: "R$ 110,00",
            note: "Avaliação 5 estrelas enviada.",
          },
          {
            id: "HIST-975",
            client: "Juliana Prado",
            service: "Alongamento em fibra",
            date: "2025-04-25",
            time: "11:00",
            location: "Tatuapé, São Paulo",
            price: "R$ 190,00",
            note: "Cliente agendou manutenção para daqui 3 semanas.",
          },
        ],
      };

      const appointmentCollections = {
        pending: "solicitacoes",
        confirmed: "confirmados",
        past: "historico",
      };

      const toComparable = (value) => (typeof value === "string" ? value.trim() : value ?? "");

      const extractPassword = (profile) => {
        const candidates = ["senha", "password", "senhaPortal", "senhaAcesso"];
        for (const field of candidates) {
          const stored = profile[field];
          if (typeof stored === "string" && stored.trim()) {
            return stored.trim();
          }
          if (typeof stored === "number") {
            return String(stored);
          }
        }
        return "";
      };

      const persistSession = (profile) => {
        const sessionPayload = {
          id: profile.id,
          email: profile.email ?? profile.emailLowercase ?? "",
          nome: profile.nome ?? profile.name ?? profile.displayName ?? "",
          telefone: profile.telefone ?? profile.phone ?? "",
        };
        localStorage.setItem(sessionKey, JSON.stringify(sessionPayload));
      };

      const readSession = () => {
        try {
          const raw = localStorage.getItem(sessionKey);
          return raw ? JSON.parse(raw) : null;
        } catch (error) {
          console.warn("Não foi possível ler a sessão armazenada", error);
          return null;
        }
      };

      const clearSession = () => {
        localStorage.removeItem(sessionKey);
      };

      const authenticateManicure = async (email, password) => {
        const manicuresRef = collection(db, "manicures");
        const attempts = [email, email.toLowerCase()];

        for (const candidate of attempts) {
          const manicureQuery = query(manicuresRef, where("email", "==", candidate), limit(1));
          const snapshot = await getDocs(manicureQuery);
          if (!snapshot.empty) {
            const document = snapshot.docs[0];
            const profile = { id: document.id, ...document.data() };
            const storedPassword = extractPassword(profile);
            if (!storedPassword) {
              throw new Error("missing-password");
            }

            if (toComparable(storedPassword) !== toComparable(password)) {
              throw new Error("invalid-credentials");
            }

            const docRef = doc(db, "manicures", profile.id);
            const latestSnapshot = await getDoc(docRef);
            if (latestSnapshot.exists()) {
              Object.assign(profile, latestSnapshot.data());
            }

            persistSession(profile);
            return profile;
          }
        }

        throw new Error("not-found");
      };

      const setStatus = (message, type = "") => {
        statusEl.textContent = message;
        statusEl.classList.remove("auth-status--error", "auth-status--success");
        statusEl.hidden = !message;
        if (type) {
          statusEl.classList.add(`auth-status--${type}`);
        }
      };

      const setLoading = (isLoading) => {
        submitButton.disabled = isLoading;
        submitButton.textContent = isLoading ? "Entrando..." : "Entrar";
      };

      const toggleView = (isLoggedIn) => {
        loginView.hidden = isLoggedIn;
        dashboard.hidden = !isLoggedIn;
      };

      const formatCurrency = (value) => {
        if (typeof value === "number") {
          return value.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        }
        if (!value) return "—";
        return value;
      };

      const parseDateValue = (rawDate, rawTime) => {
        if (!rawDate && !rawTime) return null;
        if (rawDate instanceof Timestamp) {
          return rawDate.toDate();
        }
        if (rawDate && typeof rawDate.toDate === "function") {
          return rawDate.toDate();
        }
        if (typeof rawDate === "string" && rawDate.includes("T")) {
          return new Date(rawDate);
        }
        if (typeof rawDate === "string") {
          return new Date(`${rawDate}T${rawTime || "00:00"}`);
        }
        if (rawTime instanceof Timestamp) {
          return rawTime.toDate();
        }
        return null;
      };

      const dateFormatter = new Intl.DateTimeFormat("pt-BR", {
        day: "2-digit",
        month: "short",
        weekday: "short",
      });

      const timeFormatter = new Intl.DateTimeFormat("pt-BR", {
        hour: "2-digit",
        minute: "2-digit",
      });

      const createAppointmentCard = (appointment, status) => {
        const wrapper = document.createElement("article");
        wrapper.className = `schedule-card schedule-card--${status}`;
        wrapper.setAttribute("role", "listitem");

        const heading = document.createElement("header");
        heading.className = "schedule-card__header";
        heading.innerHTML = `
          <div>
            <p class="schedule-card__service">${appointment.service}</p>
            <h3 class="schedule-card__client">${appointment.client}</h3>
          </div>
          <span class="schedule-card__id">${appointment.id}</span>
        `;

        const appointmentDate = parseDateValue(appointment.date, appointment.time);
        const formattedDate = appointmentDate ? dateFormatter.format(appointmentDate) : appointment.date ?? "—";
        const formattedTime = appointmentDate
          ? timeFormatter.format(appointmentDate)
          : appointment.time ?? "—";

        const details = document.createElement("dl");
        details.className = "schedule-card__details";
        details.innerHTML = `
          <div>
            <dt>Data</dt>
            <dd>${formattedDate}</dd>
          </div>
          <div>
            <dt>Horário</dt>
            <dd>${formattedTime}</dd>
          </div>
          <div>
            <dt>Local</dt>
            <dd>${appointment.location || "—"}</dd>
          </div>
          <div>
            <dt>Valor</dt>
            <dd>${formatCurrency(appointment.price)}</dd>
          </div>
        `;

        if (appointment.note) {
          const note = document.createElement("p");
          note.className = "schedule-card__note";
          note.textContent = appointment.note;
          wrapper.append(heading, details, note);
        } else {
          wrapper.append(heading, details);
        }

        return wrapper;
      };

      const renderAppointments = (status, appointments) => {
        const mapping = {
          pending: { list: pendingList, badge: badgePending, metric: metricPending },
          confirmed: { list: confirmedList, badge: badgeConfirmed, metric: metricConfirmed },
          past: { list: pastList, badge: badgePast, metric: metricPast },
        };

        const { list, badge, metric } = mapping[status];
        list.innerHTML = "";

        if (!appointments.length) {
          const emptyState = document.createElement("p");
          emptyState.className = "schedule-empty";
          emptyState.textContent = "Nenhum agendamento por aqui ainda.";
          list.append(emptyState);
        } else {
          appointments.forEach((appointment) => {
            list.append(createAppointmentCard(appointment, status));
          });
        }

        badge.textContent = appointments.length;
        metric.textContent = appointments.length;
      };

      const mapAppointmentSnapshot = (snapshot) => {
        const data = snapshot.data();
        return {
          id: data.id ?? snapshot.id,
          client: data.cliente ?? data.client ?? "Cliente NailNow",
          service: data.servico ?? data.service ?? "Serviço NailNow",
          date: data.data ?? data.date ?? null,
          time: data.hora ?? data.time ?? null,
          location: data.local ?? data.location ?? "",
          price: data.valor ?? data.price ?? "",
          note: data.observacao ?? data.note ?? "",
        };
      };

      const loadAppointments = async (profileId) => {
        const docRef = doc(db, "manicures", profileId);
        const results = {};

        await Promise.all(
          Object.entries(appointmentCollections).map(async ([status, collectionName]) => {
            try {
              const subCollection = collection(docRef, collectionName);
              const snapshot = await getDocs(subCollection);
              if (snapshot.empty) {
                results[status] = defaultAppointmentData[status];
                return;
              }
              results[status] = snapshot.docs.map(mapAppointmentSnapshot);
            } catch (error) {
              console.warn(`Não foi possível carregar ${collectionName}`, error);
              results[status] = defaultAppointmentData[status];
            }
          }),
        );

        renderAppointments("pending", results.pending ?? defaultAppointmentData.pending);
        renderAppointments("confirmed", results.confirmed ?? defaultAppointmentData.confirmed);
        renderAppointments("past", results.past ?? defaultAppointmentData.past);
      };

      const buildSpecialtiesLabel = (profile) => {
        const services = profile.servicos ?? profile.especialidades ?? profile.specialties;
        if (Array.isArray(services) && services.length) {
          return services.join(" · ");
        }
        if (typeof services === "string" && services.trim()) {
          return services;
        }
        return "Alongamento em fibra · Spa das mãos";
      };

      const buildAreaLabel = (profile) => {
        const parts = [
          profile.bairro ?? profile.neighborhood,
          profile.cidade ?? profile.city,
          profile.estado ?? profile.state,
        ].filter(Boolean);
        if (parts.length) {
          return parts.join(" - ");
        }
        return profile.areaAtendimento ?? profile.area_atendimento ?? "São Paulo e região metropolitana";
      };

      const hydrateDashboard = async (profile) => {
        const name = profile.nome ?? profile.name ?? profile.displayName ?? "manicure";
        profileNameElements.forEach((element) => {
          element.textContent = name;
        });
        profileDisplay.textContent = name;
        profileEmail.textContent = profile.email ?? profile.emailLowercase ?? "—";
        profileSpecialties.textContent = buildSpecialtiesLabel(profile);
        profileArea.textContent = buildAreaLabel(profile);

        await loadAppointments(profile.id);
      };

      const fetchManicureProfile = async (profileId) => {
        const docRef = doc(db, "manicures", profileId);
        const snapshot = await getDoc(docRef);
        if (!snapshot.exists()) {
          throw new Error("not-found");
        }
        const profile = { id: profileId, ...snapshot.data() };
        persistSession(profile);
        return profile;
      };

      const startWithSession = async () => {
        const session = readSession();
        if (!session || !session.id) {
          toggleView(false);
          return;
        }

        try {
          setStatus("Carregando seu painel...");
          toggleView(true);
          const profile = await fetchManicureProfile(session.id);
          await hydrateDashboard(profile);
          setStatus("");
        } catch (error) {
          console.error("Não foi possível restaurar a sessão", error);
          clearSession();
          toggleView(false);
          setStatus("Sua sessão expirou. Faça login novamente para acessar o portal.", "error");
        }
      };

      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const email = loginForm.email.value.trim();
        const password = loginForm.password.value;

        if (!email || !password) {
          setStatus("Preencha e-mail e senha para continuar.", "error");
          return;
        }

        setStatus("");
        setLoading(true);

        try {
          const profile = await authenticateManicure(email, password);
          setStatus("Login realizado com sucesso!", "success");
          loginForm.reset();
          toggleView(true);
          await hydrateDashboard(profile);
        } catch (error) {
          console.error("Erro no login", error);
          if (error.message === "missing-password") {
            setStatus(
              "Não encontramos uma senha cadastrada. Fale com o suporte NailNow para concluir o acesso.",
              "error",
            );
          } else if (error.message === "invalid-credentials") {
            setStatus("Credenciais não conferem. Confira sua senha e tente novamente.", "error");
          } else if (error.message === "not-found") {
            setStatus("Não localizamos uma manicure com esse e-mail.", "error");
          } else {
            setStatus("Não foi possível entrar. Verifique seus dados.", "error");
          }
        } finally {
          setLoading(false);
        }
      });

      resetButton.addEventListener("click", () => {
        const email = loginForm.email.value.trim();
        const supportLink =
          "mailto:contato@nailnow.com?subject=Redefini%C3%A7%C3%A3o%20de%20senha%20NailNow&body=Ol%C3%A1%20time%20NailNow,%20preciso%20redefinir%20minha%20senha.%20Meu%20e-mail%20%C3%A9%20" +
          encodeURIComponent(email || "");

        window.location.href = supportLink;
        setStatus(
          "Abrimos um e-mail para o suporte NailNow concluir a redefinição da sua senha.",
          "success",
        );
      });

      signOutButton.addEventListener("click", () => {
        clearSession();
        toggleView(false);
        setStatus("Você saiu do portal com segurança.", "success");
        renderAppointments("pending", []);
        renderAppointments("confirmed", []);
        renderAppointments("past", []);
      });

      startWithSession();
    </script>

  </body>
</html>
